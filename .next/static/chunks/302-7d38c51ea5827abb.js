"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[302],{6530:function(e,t,s){s.d(t,{Z:function(){return i}});var r=s(5893),n=s(7294),o=s(1163),l=s(9008);function i(e){let{children:t,allowedRoles:s}=e,i=(0,o.useRouter)(),[a,c]=(0,n.useState)(!0);async function d(){try{let{data:{session:e}}=await l.O.auth.getSession();if(!e){i.push("/auth/login");return}if(s){let{data:t}=await l.O.from("users").select("role").eq("id",e.user.id).single();if(!t||!s.includes(t.role)){i.push("/");return}}}catch(e){console.error("Error checking auth:",e),i.push("/auth/login")}finally{c(!1)}}return((0,n.useEffect)(()=>{d()},[]),a)?(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})}):(0,r.jsx)(r.Fragment,{children:t})}},4645:function(e,t,s){s.d(t,{Z:function(){return c}});var r=s(5893),n=s(7294),o=s(1163),l=s(9008),i=s(2920);function a(){return(0,r.jsx)("div",{className:"flex justify-center items-center p-4",children:(0,r.jsx)("img",{src:"/images/mechanic-duck.png.png",alt:"M\xe9canicien",className:"w-48 h-48 object-contain",style:{maxWidth:"100%",height:"auto"}})})}function c(e){let{children:t,title:s}=e,c=(0,o.useRouter)(),[d,u]=(0,n.useState)(!1),[m,h]=(0,n.useState)(null);(0,n.useEffect)(()=>{(async()=>{let{data:{user:e}}=await l.O.auth.getUser();if(e){let{data:t,error:s}=await l.O.from("users").select("full_name").eq("id",e.id).single();t&&t.full_name?h(t.full_name):h(e.email||null)}})()},[]);let x=async()=>{try{let{error:e}=await l.O.auth.signOut();if(e)throw e;c.push("/auth/login"),i.Am.success("D\xe9connexion r\xe9ussie")}catch(e){i.Am.error("Erreur lors de la d\xe9connexion"),console.error("Error:",e)}};return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-100",children:[(0,r.jsx)("div",{className:"fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform ".concat(d?"translate-x-0":"-translate-x-full"," lg:translate-x-0 transition-transform duration-200 ease-in-out"),children:(0,r.jsxs)("div",{className:"flex flex-col h-full",children:[(0,r.jsx)("div",{className:"flex items-center justify-center h-16 px-4 bg-blue-600",children:(0,r.jsx)("h2",{className:"text-xl font-semibold text-white",children:"ProAutoServices"})}),(0,r.jsx)("div",{className:"px-4 py-3 bg-gray-50",children:(0,r.jsxs)("p",{className:"text-sm font-medium text-gray-900",children:["Bonjour ",m]})}),(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsx)(a,{})}),(0,r.jsx)("nav",{className:"flex-1 px-4 py-4 space-y-1"}),(0,r.jsx)("div",{className:"p-4 border-t",children:(0,r.jsx)("button",{onClick:x,className:"w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:"D\xe9connexion"})})]})}),(0,r.jsxs)("div",{className:"lg:pl-64",children:[(0,r.jsxs)("div",{className:"sticky top-0 z-10 flex items-center justify-between h-16 px-4 bg-white shadow-sm",children:[(0,r.jsx)("button",{onClick:()=>u(!d),className:"p-2 text-gray-500 lg:hidden",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})})}),(0,r.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:s}),(0,r.jsx)("div",{className:"w-6 lg:hidden"})," "]}),(0,r.jsx)("main",{className:"p-4",children:t})]})]})}},3667:function(e,t,s){s.d(t,{Z:function(){return g}});var r=s(5893),n=s(7294),o=s(3907),l=s(6993),i=s(4745),a=s(9897),c=s(9008),d=s(2920),u=s(7536),m=s(1163),h=s(1915),x=s(8877),p=s.n(x);function f(e){let{isOpen:t,onClose:s,appointment:o}=e,[l,i]=(0,n.useState)(!1),[a,m]=(0,n.useState)(["","","",""]),[x,f]=(0,n.useState)(""),[b,g]=(0,n.useState)(null),[y,v]=(0,n.useState)([]),{register:j,handleSubmit:w,formState:{errors:N}}=(0,u.cI)({defaultValues:{client_name:(null==o?void 0:o.client_name)||"",phone:(null==o?void 0:o.phone)||"",address:"",brand_model:(null==o?void 0:o.vehicle)||"",registration_number:"",mileage:0,work_type:(null==o?void 0:o.service)||"",entry_date:o?new Date(o.start_time).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],exit_date:"",mechanics:[],status:"pending",parts_supplies:"",observations:""}});(0,n.useEffect)(()=>{let e=async()=>{try{let{data:e,error:t}=await c.O.from("mechanics").select("id, name").order("name");if(t)throw t;v(e||[])}catch(e){console.error("Error fetching mechanics:",e),d.Am.error("Erreur lors du chargement des m\xe9caniciens")}};t&&e()},[t]);let k=(e,t)=>{let s=[...a];s[e]=t,m(s)},_=e=>{let t=[...a];t[e]="",m(t)},S=async e=>{try{i(!0);let{data:t,error:r}=await c.O.auth.getUser();if(r||!t.user)throw Error("Non authentifi\xe9");let n={client_name:e.client_name,phone:e.phone,address:e.address,brand_model:e.brand_model,registration_number:e.registration_number,mileage:e.mileage||0,work_type:e.work_type,entry_date:e.entry_date,exit_date:e.exit_date,mechanics:e.mechanics,status:e.status,parts_supplies:e.parts_supplies,observations:e.observations,photos:a.filter(Boolean),client_signature:x||null,created_by:t.user.id,updated_by:t.user.id};console.log("Donn\xe9es \xe0 ins\xe9rer:",n);let{error:o}=await c.O.from("vehicles").insert([n]);if(o)throw console.error("Erreur Supabase d\xe9taill\xe9e:",o),o;d.Am.success("Fiche v\xe9hicule cr\xe9\xe9e avec succ\xe8s"),s()}catch(e){console.error("Error creating vehicle:",e),d.Am.error("Erreur lors de la cr\xe9ation de la fiche v\xe9hicule")}finally{i(!1)}};return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Nouvelle fiche v\xe9hicule"}),(0,r.jsxs)("button",{onClick:s,className:"text-gray-400 hover:text-gray-500",children:[(0,r.jsx)("span",{className:"sr-only",children:"Fermer"}),(0,r.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]})]}),(0,r.jsxs)("form",{onSubmit:w(S),className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"client_name",className:"block text-sm font-medium text-gray-700",children:"Nom du client"}),(0,r.jsx)("input",{type:"text",id:"client_name",...j("client_name",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),N.client_name&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700",children:"T\xe9l\xe9phone"}),(0,r.jsx)("input",{type:"tel",id:"phone",...j("phone",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),N.phone&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{className:"sm:col-span-2",children:[(0,r.jsx)("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700",children:"Adresse"}),(0,r.jsx)("input",{type:"text",id:"address",...j("address"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"brand_model",className:"block text-sm font-medium text-gray-700",children:"Marque et mod\xe8le"}),(0,r.jsx)("input",{type:"text",id:"brand_model",...j("brand_model",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),N.brand_model&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"registration_number",className:"block text-sm font-medium text-gray-700",children:"Immatriculation"}),(0,r.jsx)("input",{type:"text",id:"registration_number",...j("registration_number"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"mileage",className:"block text-sm font-medium text-gray-700",children:"Kilom\xe9trage"}),(0,r.jsx)("input",{type:"number",id:"mileage",...j("mileage",{valueAsNumber:!0,setValueAs:e=>""===e?0:parseInt(e)}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"entry_date",className:"block text-sm font-medium text-gray-700",children:"Date d'entr\xe9e"}),(0,r.jsx)("input",{type:"date",id:"entry_date",...j("entry_date",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),N.entry_date&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"exit_date",className:"block text-sm font-medium text-gray-700",children:"Date de sortie pr\xe9vue"}),(0,r.jsx)("input",{type:"date",id:"exit_date",...j("exit_date"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"mechanics",className:"block text-sm font-medium text-gray-700",children:"M\xe9caniciens"}),(0,r.jsx)("select",{multiple:!0,id:"mechanics",...j("mechanics"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm",children:y.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Maintenez Ctrl (ou Cmd sur Mac) pour s\xe9lectionner plusieurs m\xe9caniciens"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700",children:"Statut"}),(0,r.jsxs)("select",{id:"status",...j("status",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm",children:[(0,r.jsx)("option",{value:"pending",children:"En attente"}),(0,r.jsx)("option",{value:"in_progress",children:"En cours"}),(0,r.jsx)("option",{value:"completed",children:"Termin\xe9"}),(0,r.jsx)("option",{value:"cancelled",children:"Annul\xe9"})]}),N.status&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{className:"sm:col-span-2",children:[(0,r.jsx)("label",{htmlFor:"work_type",className:"block text-sm font-medium text-gray-700",children:"Type de travaux"}),(0,r.jsx)("textarea",{id:"work_type",rows:4,...j("work_type",{required:!0}),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"}),N.work_type&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{className:"sm:col-span-2",children:[(0,r.jsx)("label",{htmlFor:"parts_supplies",className:"block text-sm font-medium text-gray-700",children:"Pi\xe8ces et fournitures"}),(0,r.jsx)("textarea",{id:"parts_supplies",rows:4,...j("parts_supplies"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]}),(0,r.jsxs)("div",{className:"sm:col-span-2",children:[(0,r.jsx)("label",{htmlFor:"observations",className:"block text-sm font-medium text-gray-700",children:"Observations"}),(0,r.jsx)("textarea",{id:"observations",rows:4,...j("observations"),className:"mt-1 block w-full border-2 border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"})]})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Photos du v\xe9hicule"}),(0,r.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:a.map((e,t)=>(0,r.jsx)(h.Z,{index:t,imageUrl:e,onUpload:e=>k(t,e),onDelete:()=>_(t)},t))})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Signature du client"}),(0,r.jsxs)("div",{className:"border-2 border-gray-300 rounded-md",children:[(0,r.jsx)(p(),{ref:e=>g(e),canvasProps:{className:"signature-canvas",style:{width:"100%",height:"160px"},width:500,height:160},minWidth:1,maxWidth:2.5,velocityFilterWeight:.7}),(0,r.jsxs)("div",{className:"mt-2 flex justify-end space-x-2",children:[(0,r.jsx)("button",{type:"button",onClick:()=>{null==b||b.clear(),f("")},className:"px-3 py-1 text-sm text-gray-600 hover:text-gray-900",children:"Effacer"}),(0,r.jsx)("button",{type:"button",onClick:()=>{if(!b||b.isEmpty()){d.Am.error("Veuillez signer avant de sauvegarder");return}f(b.getTrimmedCanvas().toDataURL("image/png"))},className:"px-3 py-1 text-sm text-blue-600 hover:text-blue-900",children:"Sauvegarder"})]})]})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,r.jsx)("button",{type:"button",onClick:s,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Annuler"}),(0,r.jsx)("button",{type:"submit",disabled:l,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:l?"Cr\xe9ation...":"Cr\xe9er la fiche"})]})]})]})}):null}function b(e){let{appointment:t,selectedDate:s,onClose:o,onSuccess:l,onDelete:i}=e,[a,h]=(0,n.useState)(!1),[x,p]=(0,n.useState)(!1);(0,m.useRouter)();let{register:b,handleSubmit:g,formState:{errors:y},reset:v}=(0,u.cI)({defaultValues:t?{client_name:t.client_name,phone:t.phone,vehicle:t.vehicle,service:t.service,notes:t.notes}:{service:"Vidange"}});(0,n.useEffect)(()=>{t&&v({client_name:t.client_name,phone:t.phone,vehicle:t.vehicle,service:t.service,notes:t.notes})},[t,v]);let j=async e=>{try{h(!0);let r=t?new Date(t.start_time):s||new Date,n=new Date(r.getTime()+36e5),o={client_name:e.client_name,phone:e.phone,vehicle:e.vehicle,service:e.service,start_time:r.toISOString(),end_time:n.toISOString(),notes:e.notes||null};if(t){let{error:e}=await c.O.from("appointments").update(o).eq("id",t.id);if(e)throw e}else{let{error:e}=await c.O.from("appointments").insert([o]);if(e)throw e}d.Am.success(t?"Rendez-vous modifi\xe9":"Rendez-vous cr\xe9\xe9"),l()}catch(e){console.error("Error saving appointment:",e),d.Am.error("Erreur lors de l'enregistrement du rendez-vous")}finally{h(!1)}};return(0,r.jsxs)("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto",children:[(0,r.jsx)("h2",{className:"text-lg font-medium mb-4",children:t?"Modifier le rendez-vous":"Nouveau rendez-vous"}),(0,r.jsxs)("form",{onSubmit:g(j),className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"client_name",className:"block text-sm font-medium text-gray-700",children:"Nom du client"}),(0,r.jsx)("input",{type:"text",id:"client_name",...b("client_name",{required:!0}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),y.client_name&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700",children:"T\xe9l\xe9phone"}),(0,r.jsx)("input",{type:"tel",id:"phone",...b("phone",{required:!0}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),y.phone&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"vehicle",className:"block text-sm font-medium text-gray-700",children:"V\xe9hicule"}),(0,r.jsx)("input",{type:"text",id:"vehicle",...b("vehicle",{required:!0}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),y.vehicle&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"service",className:"block text-sm font-medium text-gray-700",children:"Type de travaux"}),(0,r.jsx)("textarea",{id:"service",...b("service",{required:!0}),rows:6,className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2 min-h-[200px]"}),y.service&&(0,r.jsx)("span",{className:"text-red-500 text-sm",children:"Ce champ est requis"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),(0,r.jsx)("textarea",{id:"notes",...b("notes"),rows:3,className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-3",children:[t&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{type:"button",onClick:()=>p(!0),className:"px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",children:"Cr\xe9er une fiche"}),(0,r.jsx)("button",{type:"button",onClick:()=>{window.confirm("\xcates-vous s\xfbr de vouloir supprimer ce rendez-vous ?")&&i(t.id)},className:"px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:"Supprimer"})]}),(0,r.jsx)("button",{type:"button",onClick:o,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Annuler"}),(0,r.jsx)("button",{type:"submit",disabled:a,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:t?"Modifier":"Cr\xe9er"})]})]})]}),x&&(0,r.jsx)(f,{isOpen:x,onClose:()=>p(!1),appointment:t})]})}function g(){let[e,t]=(0,n.useState)([]),[s,u]=(0,n.useState)(null),[m,h]=(0,n.useState)(!1),[x,p]=(0,n.useState)(null);(0,n.useEffect)(()=>{f()},[]);let f=async()=>{try{let{data:e,error:s}=await c.O.from("appointments").select("*").gte("start_time",new Date(Date.now()-6048e5).toISOString());if(s)throw s;let r=e.map(e=>({...e,title:"".concat(e.client_name," - ").concat(e.service),start:e.start_time,end:e.end_time}));t(r)}catch(e){console.error("Error fetching appointments:",e),d.Am.error("Erreur lors du chargement des rendez-vous")}},g=async t=>{try{let s=e.find(e=>e.id===t.event.extendedProps.id);if(!s)return;let r=new Date(s.start_time),n=(new Date(s.end_time).getTime()-r.getTime())/6e4,o=new Date(t.event.start),l=new Date(o.getTime()+6e4*n),i=o.toISOString(),a=l.toISOString(),{data:u,error:m}=await c.O.from("appointments").update({start_time:i,end_time:a}).eq("id",s.id).select();if(m)throw m;(null==x?void 0:x.id)===s.id&&p({id:x.id,title:x.title,client_name:x.client_name,phone:x.phone,vehicle:x.vehicle,service:x.service,notes:x.notes,start_time:i,end_time:a}),d.Am.success("Rendez-vous d\xe9plac\xe9 avec succ\xe8s"),await f()}catch(e){console.error("Error updating appointment:",e),d.Am.error("Erreur lors du d\xe9placement du rendez-vous"),t.revert()}},y=async e=>{try{let{error:t}=await c.O.from("appointments").delete().eq("id",e);if(t)throw t;d.Am.success("Rendez-vous supprim\xe9 avec succ\xe8s"),h(!1),f()}catch(e){console.error("Error deleting appointment:",e),d.Am.error("Erreur lors de la suppression du rendez-vous")}},v=e=>{switch(e.toLowerCase()){case"vidange":return"#4CAF50";case"r\xe9paration":return"#F44336";case"d\xe9pannage":return"#FF9800";case"diagnostic":return"#2196F3";case"pneumatique":return"#9C27B0";case"climatisation":return"#00BCD4";default:return"#607D8B"}};return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("div",{className:"bg-white p-4 rounded-lg shadow",children:(0,r.jsx)(o.Z,{plugins:[l.Z,i.Z,a.ZP],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek"},editable:!0,droppable:!0,eventDrop:g,dateClick:e=>{u(e.date),document.querySelectorAll(".fc-day-selected").forEach(e=>{e.classList.remove("fc-day-selected")}),e.dayEl.classList.add("fc-day-selected"),p(null),h(!0)},eventClick:t=>{let s=e.find(e=>e.id===t.event.extendedProps.id);s&&(p(s),h(!0))},events:e.map(e=>({...e,backgroundColor:v(e.service),extendedProps:{id:e.id}})),height:"auto",locale:"fr",buttonText:{today:"Aujourd'hui",month:"Mois",week:"Semaine"}})}),m&&(0,r.jsx)(b,{appointment:x,selectedDate:s,onClose:()=>{h(!1),p(null)},onSuccess:()=>{h(!1),p(null),f()},onDelete:y})]})}},1915:function(e,t,s){s.d(t,{Z:function(){return c}});var r=s(5893),n=s(7294),o=s(5675),l=s.n(o),i=s(9008),a=s(2920);function c(e){let{imageUrl:t,onUpload:s,onDelete:o,index:c}=e,[d,u]=(0,n.useState)(!1),[m,h]=(0,n.useState)(null);(0,n.useEffect)(()=>{t&&h(null)},[t]);let x=async e=>{try{var t;if(u(!0),!e.target.files||0===e.target.files.length)throw Error("Veuillez s\xe9lectionner une image");let r=e.target.files[0],n=(null===(t=r.name.split(".").pop())||void 0===t?void 0:t.toLowerCase())||"";if(!["jpg","jpeg","png","gif"].includes(n))throw Error("Format de fichier non support\xe9. Utilisez JPG, PNG ou GIF");if(r.size>5242880)throw Error("La taille du fichier ne doit pas d\xe9passer 5MB");let o="".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9),".").concat(n),l=new FileReader;l.onloadend=()=>{h(l.result)},l.readAsDataURL(r);let{error:a,data:c}=await i.O.storage.from("vehicle-photos").upload(o,r,{cacheControl:"3600",upsert:!1,contentType:"image/".concat("jpg"===n?"jpeg":n)});if(a)throw console.error("Upload error details:",a),Error(a.message);if(null==c?void 0:c.path){let{data:e}=i.O.storage.from("vehicle-photos").getPublicUrl(o);if(null==e?void 0:e.publicUrl)s(e.publicUrl);else throw Error("Erreur lors de la r\xe9cup\xe9ration de l'URL publique")}else throw Error("Erreur lors du t\xe9l\xe9chargement du fichier")}catch(e){console.error("Upload error:",e),a.Am.error(e.message||"Erreur lors du t\xe9l\xe9chargement"),h(null)}finally{u(!1)}},p=async()=>{if(o)try{if(t){let e=t.split("/").pop();if(e){let{error:t}=await i.O.storage.from("vehicle-photos").remove([e]);if(t)throw console.error("Error deleting file:",t),Error("Erreur lors de la suppression du fichier")}}h(null),o()}catch(e){console.error("Error in handleDelete:",e),a.Am.error(e.message||"Erreur lors de la suppression de l'image")}},f=t||m;return(0,r.jsx)("div",{className:"relative w-full h-40 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 hover:border-gray-400 transition-colors",children:f?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l(),{src:f,alt:"Photo ".concat(c+1),fill:!0,sizes:"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw",className:"object-contain p-2 rounded-lg",unoptimized:null!==m,priority:0===c}),(0,r.jsx)("button",{onClick:p,className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md hover:bg-red-600 transition-colors z-10",type:"button",title:"Supprimer la photo",children:"\xd7"})]}):(0,r.jsxs)("label",{className:"flex flex-col items-center justify-center w-full h-full cursor-pointer",children:[(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[(0,r.jsx)("svg",{className:"w-8 h-8 mb-3 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),(0,r.jsxs)("p",{className:"text-sm text-gray-500",children:["Photo ",c+1]}),d&&(0,r.jsx)("div",{className:"mt-2 text-sm text-blue-500",children:"Chargement..."})]}),(0,r.jsx)("input",{type:"file",className:"hidden",accept:"image/jpeg,image/png,image/gif",onChange:x,disabled:d})]})})}},9008:function(e,t,s){s.d(t,{O:function(){return r}});let r=(0,s(6490).eI)("https://pjxtjkmqgkbisgfleaps.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqeHRqa21xZ2tiaXNnZmxlYXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxOTAzMzAsImV4cCI6MjA1MTc2NjMzMH0.UjKK4kSJDapIRx0iJvdHiJZzMbi99tDx52FmSq4qyfE",{auth:{persistSession:!0,autoRefreshToken:!0}})}}]);