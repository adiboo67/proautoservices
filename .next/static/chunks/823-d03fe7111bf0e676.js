"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[823],{7318:function(e,s,r){r.d(s,{Z:function(){return n}});var t=r(5893),l=r(7294),a=r(8877),i=r.n(a),o=r(6501);function n(e){let{onSave:s=()=>{},existingSignature:r}=e,a=(0,l.useRef)(null),[n,c]=(0,l.useState)(!!r);return(0,t.jsx)("div",{className:"space-y-4",children:n&&r?(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("img",{src:r,alt:"Signature existante",className:"border rounded-lg p-2 bg-white"}),(0,t.jsx)("button",{onClick:()=>c(!1),className:"text-sm text-blue-600 hover:text-blue-800",children:"Modifier la signature"})]}):(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("div",{className:"border rounded-lg bg-white",children:(0,t.jsx)(i(),{ref:a,canvasProps:{className:"signature-canvas w-full h-40"}})}),(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)("button",{onClick:()=>{var e;null===(e=a.current)||void 0===e||e.clear()},className:"px-3 py-1 text-sm text-gray-600 hover:text-gray-800",children:"Effacer"}),(0,t.jsx)("button",{onClick:()=>{var e,r;if(null===(e=a.current)||void 0===e?void 0:e.isEmpty()){o.ZP.error("Veuillez signer avant de sauvegarder");return}let t=null===(r=a.current)||void 0===r?void 0:r.toDataURL();t&&s&&(s(t),o.ZP.success("Signature enregistr\xe9e"))},className:"px-3 py-1 text-sm text-white bg-blue-600 rounded hover:bg-blue-700",children:"Sauvegarder"})]})]})})}},5823:function(e,s,r){r.d(s,{Z:function(){return u}});var t=r(5893),l=r(7294),a=r(9008),i=r(2920),o=r(7536),n=r(7318),c=r(1915);function d(e){var s;let{vehicle:r,onClose:d,onSuccess:u}=e,[m,x]=(0,l.useState)(!1),[h,p]=(0,l.useState)((null==r?void 0:r.client_signature)||null),[b,g]=(0,l.useState)([]),[f,v]=(0,l.useState)((null==r?void 0:null===(s=r.mechanics)||void 0===s?void 0:s.map(e=>e.toString()))||[]),[y,j]=(0,l.useState)([]),{register:w,handleSubmit:N,setValue:_,formState:{errors:k}}=(0,o.cI)({defaultValues:{client_name:(null==r?void 0:r.client_name)||"",address:(null==r?void 0:r.address)||"",phone:(null==r?void 0:r.phone)||"",brand_model:(null==r?void 0:r.brand_model)||"",mileage:(null==r?void 0:r.mileage)||void 0,work_type:(null==r?void 0:r.work_type)||"",parts_supplies:(null==r?void 0:r.parts_supplies)||"",entry_date:(null==r?void 0:r.entry_date)||"",exit_date:(null==r?void 0:r.exit_date)||"",observations:(null==r?void 0:r.observations)||"",registration_number:(null==r?void 0:r.registration_number)||"",status:(null==r?void 0:r.status)||"pending",mechanics:[]}});(0,l.useEffect)(()=>{C(),j([,,,,].fill("").map((e,s)=>{var t;return(null==r?void 0:null===(t=r.photos)||void 0===t?void 0:t[s])||""})),r&&Object.entries(r).forEach(e=>{let[s,r]=e;"mechanics"!==s&&"photos"!==s&&"client_signature"!==s&&_(s,r)})},[r,_]);let C=async()=>{try{let{data:e,error:s}=await a.O.from("mechanics").select("id, name").order("name");if(s)throw s;console.log("Mechanics fetched:",e),g(e||[])}catch(e){console.error("Error fetching mechanics:",e),i.Am.error("Erreur lors du chargement des m\xe9caniciens")}},S=(e,s)=>{let r=[...y];r[e]=s,j(r)},E=async e=>{try{let s=y[e];if(s){let e=s.split("/").pop();if(e){let{error:s}=await a.O.storage.from("vehicle-photos").remove([e]);if(s)throw console.error("Error deleting photo from storage:",s),s}}let r=[...y];r[e]="",j(r)}catch(e){console.error("Error deleting photo:",e),i.Am.error("Erreur lors de la suppression de la photo")}},A=async e=>{try{x(!0);let s=f.map(e=>parseInt(e,10)),t={client_name:e.client_name,address:e.address,phone:e.phone,brand_model:e.brand_model,mileage:e.mileage,work_type:e.work_type,parts_supplies:e.parts_supplies,entry_date:e.entry_date,exit_date:e.exit_date,observations:e.observations,registration_number:e.registration_number,status:e.status,mechanics:s,client_signature:h,photos:y.filter(e=>e&&""!==e.trim())},l=Object.fromEntries(Object.entries(t).filter(e=>{let[s,r]=e;return Array.isArray(r)?r.length>0:void 0!==r&&""!==r&&null!==r}));h||(l.client_signature=null),y.every(e=>!e||""===e.trim())&&(l.photos=[]);let{data:o,error:n}=(null==r?void 0:r.id)?await a.O.from("vehicles").update(l).eq("id",r.id):await a.O.from("vehicles").insert(l).select();if(n)throw console.error("Supabase error:",n),n;i.Am.success(r?"V\xe9hicule modifi\xe9 avec succ\xe8s":"V\xe9hicule ajout\xe9 avec succ\xe8s"),u()}catch(e){console.error("Error saving vehicle:",e),i.Am.error(r?"Erreur lors de la modification du v\xe9hicule":"Erreur lors de l'ajout du v\xe9hicule")}finally{x(!1)}};return(0,t.jsx)("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4",children:(0,t.jsx)("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:(0,t.jsxs)("div",{className:"p-6",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold mb-4",children:r?"Modifier le v\xe9hicule":"Ajouter un v\xe9hicule"}),(0,t.jsxs)("form",{onSubmit:N(A),className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Nom du client"}),(0,t.jsx)("input",{type:"text",...w("client_name",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.client_name&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.client_name.message})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Adresse"}),(0,t.jsx)("input",{type:"text",...w("address"),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"T\xe9l\xe9phone"}),(0,t.jsx)("input",{type:"text",...w("phone",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.phone&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.phone.message})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Marque et Mod\xe8le"}),(0,t.jsx)("input",{type:"text",...w("brand_model",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.brand_model&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.brand_model.message})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Kilom\xe9trage"}),(0,t.jsx)("input",{type:"number",...w("mileage"),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Immatriculation"}),(0,t.jsx)("input",{type:"text",...w("registration_number",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.registration_number&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.registration_number.message})]}),(0,t.jsxs)("div",{className:"col-span-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Type de travaux"}),(0,t.jsx)("input",{type:"text",...w("work_type",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.work_type&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.work_type.message})]}),(0,t.jsxs)("div",{className:"col-span-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Pi\xe8ces et fournitures"}),(0,t.jsx)("textarea",{...w("parts_supplies"),rows:3,className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Date d'entr\xe9e"}),(0,t.jsx)("input",{type:"date",...w("entry_date",{required:"Ce champ est requis"}),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"}),k.entry_date&&(0,t.jsx)("p",{className:"mt-1 text-sm text-red-600",children:k.entry_date.message})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Date de sortie pr\xe9vue"}),(0,t.jsx)("input",{type:"date",...w("exit_date"),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Statut"}),(0,t.jsxs)("select",{...w("status"),className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2",children:[(0,t.jsx)("option",{value:"pending",children:"En attente"}),(0,t.jsx)("option",{value:"in_progress",children:"En cours"}),(0,t.jsx)("option",{value:"done",children:"Termin\xe9"}),(0,t.jsx)("option",{value:"validated",children:"Valid\xe9"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"M\xe9caniciens"}),(0,t.jsx)("select",{multiple:!0,value:f,onChange:e=>{v(Array.from(e.target.selectedOptions,e=>e.value))},className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2",size:4,children:b.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name},e.id))}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Maintenez Ctrl (ou Cmd sur Mac) pour s\xe9lectionner plusieurs m\xe9caniciens"})]}),(0,t.jsxs)("div",{className:"col-span-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Observations"}),(0,t.jsx)("textarea",{...w("observations"),rows:3,className:"mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:border-2"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Photos du v\xe9hicule"}),(0,t.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:y.map((e,s)=>(0,t.jsx)(c.Z,{index:s,imageUrl:e,onUpload:e=>S(s,e),onDelete:()=>E(s)},"".concat(s,"-").concat(e)))}),(0,t.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Vous pouvez ajouter jusqu'\xe0 4 photos du v\xe9hicule"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700",children:"Signature du client"}),(0,t.jsx)(n.Z,{existingSignature:h,onSave:e=>p(e)})]}),(0,t.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,t.jsx)("button",{type:"button",onClick:d,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Annuler"}),(0,t.jsx)("button",{type:"submit",disabled:m,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:m?"Enregistrement...":r?"Modifier":"Ajouter"})]})]})]})})})}function u(){let[e,s]=(0,l.useState)([]),[r,o]=(0,l.useState)(!0),[n,c]=(0,l.useState)(!1),[u,m]=(0,l.useState)(null),[x,h]=(0,l.useState)("");(0,l.useEffect)(()=>{p()},[]);let p=async()=>{try{let{data:e,error:r}=await a.O.from("vehicles").select("*").order("entry_date",{ascending:!1}).order("created_at",{ascending:!1}).order("id",{ascending:!1});if(r)throw r;let{data:t,error:l}=await a.O.from("mechanics").select("id, name");if(l)throw l;let i=new Map(t.map(e=>[e.id,e])),o=e.map(e=>({...e,mechanicsList:Array.isArray(e.mechanics)?e.mechanics.map(e=>{var s;return null===(s=i.get(e))||void 0===s?void 0:s.name}).filter(Boolean).join(", "):""}));s(o||[])}catch(e){console.error("Error fetching vehicles:",e),i.Am.error("Erreur lors du chargement des v\xe9hicules")}finally{o(!1)}},b=e.filter(e=>{var s,r,t,l;let a=x.toLowerCase();return(null===(s=e.client_name)||void 0===s?void 0:s.toLowerCase().includes(a))||(null===(r=e.brand_model)||void 0===r?void 0:r.toLowerCase().includes(a))||(null===(t=e.registration_number)||void 0===t?void 0:t.toLowerCase().includes(a))||(null===(l=e.work_type)||void 0===l?void 0:l.toLowerCase().includes(a))}),g=e=>{m(e),c(!0)},f=async e=>{if(confirm("\xcates-vous s\xfbr de vouloir supprimer ce v\xe9hicule ?"))try{let{error:s}=await a.O.from("vehicles").delete().eq("id",e);if(s)throw s;i.Am.success("V\xe9hicule supprim\xe9 avec succ\xe8s"),p()}catch(e){console.error("Error deleting vehicle:",e),i.Am.error("Erreur lors de la suppression du v\xe9hicule")}},v=e=>{switch(e){case"pending":return"En attente";case"in_progress":return"En cours";case"done":return"Termin\xe9";case"validated":return"Valid\xe9";default:return e}},y=e=>{switch(e){case"pending":return"bg-yellow-100 text-yellow-800";case"in_progress":return"bg-blue-100 text-blue-800";case"done":return"bg-green-100 text-green-800";case"validated":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}};return r?(0,t.jsx)("div",{children:"Chargement..."}):(0,t.jsxs)("div",{className:"px-4 sm:px-6 lg:px-8",children:[(0,t.jsxs)("div",{className:"sm:flex sm:items-center",children:[(0,t.jsxs)("div",{className:"sm:flex-auto",children:[(0,t.jsx)("h1",{className:"text-base font-semibold leading-6 text-gray-900",children:"Fiches V\xe9hicules"}),(0,t.jsx)("p",{className:"mt-2 text-sm text-gray-700",children:"Liste des v\xe9hicules en r\xe9paration"})]}),(0,t.jsx)("div",{className:"mt-4 sm:ml-16 sm:mt-0 sm:flex-none",children:(0,t.jsx)("button",{onClick:()=>{m(null),c(!0)},type:"button",className:"block rounded-md bg-blue-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600",children:"Ajouter une fiche"})})]}),(0,t.jsx)("div",{className:"mt-4",children:(0,t.jsxs)("div",{className:"relative rounded-md shadow-sm",children:[(0,t.jsx)("input",{type:"text",value:x,onChange:e=>h(e.target.value),placeholder:"Rechercher par nom, mod\xe8le, immatriculation...",className:"block w-full rounded-md border-gray-300 pl-4 pr-12 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"}),(0,t.jsx)("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3",children:(0,t.jsx)("svg",{className:"h-5 w-5 text-gray-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z",clipRule:"evenodd"})})})]})}),(0,t.jsx)("div",{className:"mt-8 flow-root",children:(0,t.jsx)("div",{className:"-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8",children:(0,t.jsx)("div",{className:"inline-block min-w-full py-2 align-middle",children:(0,t.jsxs)("table",{className:"min-w-full divide-y divide-gray-300",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{scope:"col",className:"py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6 lg:pl-8",children:"Client"}),(0,t.jsx)("th",{scope:"col",className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"V\xe9hicule"}),(0,t.jsx)("th",{scope:"col",className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Immatriculation"}),(0,t.jsx)("th",{scope:"col",className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"Statut"}),(0,t.jsx)("th",{scope:"col",className:"px-3 py-3.5 text-left text-sm font-semibold text-gray-900",children:"M\xe9caniciens"}),(0,t.jsx)("th",{scope:"col",className:"relative py-3.5 pl-3 pr-4 sm:pr-6 lg:pr-8",children:(0,t.jsx)("span",{className:"sr-only",children:"Actions"})})]})}),(0,t.jsx)("tbody",{className:"divide-y divide-gray-200 bg-white",children:r?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:6,className:"text-center py-4",children:"Chargement..."})}):0===b.length?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:6,className:"text-center py-4 text-gray-500",children:x?"Aucun v\xe9hicule ne correspond \xe0 votre recherche":"Aucun v\xe9hicule enregistr\xe9"})}):b.map(e=>(0,t.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,t.jsx)("td",{className:"whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6 lg:pl-8",children:e.client_name}),(0,t.jsx)("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500",children:e.brand_model}),(0,t.jsx)("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500",children:e.registration_number||"-"}),(0,t.jsx)("td",{className:"whitespace-nowrap px-3 py-4 text-sm",children:(0,t.jsx)("span",{className:"inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ".concat(y(e.status)),children:v(e.status)})}),(0,t.jsx)("td",{className:"whitespace-nowrap px-3 py-4 text-sm text-gray-500",children:e.mechanicsList||"-"}),(0,t.jsxs)("td",{className:"relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6 lg:pr-8",children:[(0,t.jsx)("button",{onClick:()=>g(e),className:"text-blue-600 hover:text-blue-900 mr-4",children:"Modifier"}),(0,t.jsx)("button",{onClick:()=>f(e.id),className:"text-red-600 hover:text-red-900",children:"Supprimer"})]})]},e.id))})]})})})}),n&&(0,t.jsx)(d,{vehicle:u,onClose:()=>c(!1),onSuccess:()=>{c(!1),p()}})]})}}}]);